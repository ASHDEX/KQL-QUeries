let lookback = 6h;
let minUsersTargeted = 10;
let maxAttemptsPerUser = 5;
SigninLogs
| where TimeGenerated > ago(lookback)
| where ResultType in ("50053","50126","50034","50056")  // invalid creds / account issues
| summarize Attempts=count(), Users=dcount(UserPrincipalName) by IPAddress, bin(TimeGenerated, 10m), AppDisplayName, ResultType
| where Users >= minUsersTargeted
| join kind=leftouter (
    SigninLogs
    | summarize AttemptsPerUser=count() by IPAddress, UserPrincipalName
) on IPAddress
| where AttemptsPerUser <= maxAttemptsPerUser
| project TimeGenerated, IPAddress, UsersTargeted=Users, Attempts, AppDisplayName, ResultType
| order by UsersTargeted desc, Attempts desc
