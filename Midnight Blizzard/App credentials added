let lookback = 14d;
AuditLogs
| where TimeGenerated > ago(lookback)
| where Category == "ApplicationManagement"
| where OperationName has_any ("Add application key","Update application â€“ Certificates and secrets","Add service principal credentials")
| extend AppId = tostring(TargetResources[0].id),
         AppName = tostring(TargetResources[0].displayName),
         Initiator = tostring(InitiatedBy.user.userPrincipalName)
| where isnotempty(Initiator)  // Focus on user-initiated changes
| summarize CredentialAdditions=count(),
          FirstAdded=min(TimeGenerated),
          LastAdded=max(TimeGenerated),
          Operations=make_set(OperationName)
          by AppId, AppName, Initiator
| where CredentialAdditions >= 3 or  // Multiple additions
        (FirstAdded > ago(7d) and CredentialAdditions >= 2)  // New apps with multiple creds
| extend SuspiciousPattern = case(
    CredentialAdditions >= 5, "HIGH_FREQUENCY_CREDS",
    FirstAdded > ago(24h) and CredentialAdditions >= 2, "RAPID_CREDENTIAL_SETUP",
    LastAdded - FirstAdded <= 1h and CredentialAdditions >= 3, "BURST_CREDENTIAL_ACTIVITY",
    "MULTIPLE_CREDENTIALS")
| order by LastAdded desc
